<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª°æ˜¯ä»£èª²ç‹ ğŸ«…</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (ä½¿ç”¨ SVG å®šç¾©ä»¥ç¢ºä¿å–®ä¸€æª”æ¡ˆé‹ä½œ) -->
    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Font Handwriting Fallback */
        .font-handwriting {
            font-family: 'Segoe Print', 'Comic Sans MS', sans-serif;
        }

        /* Animations */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.6s ease-out forwards;
        }
    </style>
</head>
<body class="bg-sky-50 text-slate-700">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons Components (Lucide SVG paths) ---
        const IconBase = ({ size = 24, className = "", children, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Crown = (props) => <IconBase {...props}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Calendar = (props) => <IconBase {...props}><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></IconBase>;
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Camera = (props) => <IconBase {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>;
        const LayoutDashboard = (props) => <IconBase {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>;
        const List = (props) => <IconBase {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconBase>;


        // åƒè³½è€…åå–®
        const TEACHERS = ['JOJO', 'æ¯›æ¯›', 'å®‰å®‰'];

        // é è¨­é ­åƒ
        const DEFAULT_AVATARS = {
            'JOJO': 'https://api.dicebear.com/9.x/adventurer/svg?seed=JOJO&backgroundColor=ffdfbf',
            'æ¯›æ¯›': 'https://api.dicebear.com/9.x/adventurer/svg?seed=MaoMao&backgroundColor=b6e3f4',
            'å®‰å®‰': 'https://api.dicebear.com/9.x/adventurer/svg?seed=AnAn&backgroundColor=c0aede',
        };

        // è¨ˆåˆ†è¦å‰‡å¸¸æ•¸
        const SCORING_RULES = {
            period: { label: 'ä»£ä¸€ç¯€èª²', points: 1, type: 'substitute' },
            homeroom_half: { label: 'ä»£å° (åŠæ—¥)', points: 2.5, type: 'homeroom' },
            homeroom_full: { label: 'ä»£å° (å…¨æ—¥)', points: 5, type: 'homeroom' },
        };

        function SubstituteKingApp() {
            // --- ç‹€æ…‹ç®¡ç† ---
            const [records, setRecords] = useState(() => {
                const saved = localStorage.getItem('substitute_records');
                return saved ? JSON.parse(saved) : [];
            });

            const [avatars, setAvatars] = useState(() => {
                const saved = localStorage.getItem('teacher_avatars');
                return saved ? JSON.parse(saved) : DEFAULT_AVATARS;
            });
            
            const [selectedMonth, setSelectedMonth] = useState(() => {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            });

            const [activeTab, setActiveTab] = useState('add');
            const fileInputRef = useRef(null);
            const [editingTeacher, setEditingTeacher] = useState(null);

            // --- Effect: è³‡æ–™æŒä¹…åŒ– ---
            useEffect(() => {
                localStorage.setItem('substitute_records', JSON.stringify(records));
            }, [records]);

            useEffect(() => {
                localStorage.setItem('teacher_avatars', JSON.stringify(avatars));
            }, [avatars]);

            // --- å‹•ä½œè™•ç† ---
            const handleAddRecord = (teacher, ruleKey) => {
                const rule = SCORING_RULES[ruleKey];
                const newRecord = {
                    id: Date.now(),
                    teacher,
                    ruleKey,
                    points: rule.points,
                    type: rule.type,
                    timestamp: new Date().toISOString(),
                    dateStr: new Date().toISOString().split('T')[0]
                };
                setRecords([newRecord, ...records]);
            };

            const handleDeleteRecord = (id) => {
                if (window.confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
                    setRecords(records.filter(r => r.id !== id));
                }
            };

            const triggerUpload = (teacherName) => {
                setEditingTeacher(teacherName);
                fileInputRef.current?.click();
            };

            const handleFileChange = (event) => {
                const file = event.target.files?.[0];
                if (file && editingTeacher) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setAvatars(prev => ({
                            ...prev,
                            [editingTeacher]: reader.result
                        }));
                    };
                    reader.readAsDataURL(file);
                }
                event.target.value = '';
            };

            // --- è¨ˆç®—é‚è¼¯ ---
            const stats = useMemo(() => {
                const initialStats = TEACHERS.reduce((acc, teacher) => {
                    acc[teacher] = {
                        name: teacher,
                        totalPoints: 0,
                        substituteCount: 0, 
                        homeroomScore: 0,   
                        homeroomDays: 0,    
                    };
                    return acc;
                }, {});

                records.forEach(record => {
                    if (record.dateStr.startsWith(selectedMonth)) {
                        const teacherStat = initialStats[record.teacher];
                        if (teacherStat) {
                            teacherStat.totalPoints += record.points;
                            if (record.type === 'substitute') {
                                teacherStat.substituteCount += 1;
                            } else if (record.type === 'homeroom') {
                                teacherStat.homeroomScore += record.points;
                                teacherStat.homeroomDays += (record.ruleKey === 'homeroom_full' ? 1 : 0.5);
                            }
                        }
                    }
                });

                return Object.values(initialStats).sort((a, b) => b.totalPoints - a.totalPoints);
            }, [records, selectedMonth]);

            const king = stats[0]?.totalPoints > 0 ? stats[0].name : null;

            // --- å…§éƒ¨çµ„ä»¶ï¼šæ’è¡Œæ¦œå¡ç‰‡ ---
            const LeaderboardCard = () => (
                <div className="bg-white rounded-3xl shadow-xl shadow-sky-100 overflow-hidden border border-sky-50 h-full">
                    <div className="bg-gradient-to-r from-sky-500 to-blue-600 p-4 flex justify-between items-center text-white shadow-sm sticky top-0 z-10">
                        <h2 className="font-bold text-lg flex items-center gap-2">
                            <Trophy className="text-yellow-300 fill-yellow-300" size={20} />
                            æœ¬æœˆæˆ°æ³
                        </h2>
                        <div className="text-xs bg-white/20 px-2 py-1 rounded text-white font-medium">
                            {selectedMonth}
                        </div>
                    </div>
                    
                    <div className="divide-y divide-slate-50 overflow-y-auto max-h-[600px]">
                        {stats.map((teacher, index) => {
                            const isKing = teacher.name === king;
                            let rankStyle = 'hover:bg-sky-50/50';
                            if (index === 0 && teacher.totalPoints > 0) rankStyle = 'bg-yellow-50 border-l-4 border-yellow-400';
                            
                            return (
                                <div key={teacher.name} className={`p-4 transition-all ${rankStyle} flex items-center justify-between group`}>
                                    <div className="flex items-center gap-4">
                                        <div className="relative group/avatar cursor-pointer" onClick={() => triggerUpload(teacher.name)} title="é»æ“Šæ›´æ›é ­è²¼">
                                            <div className="w-14 h-14 rounded-full p-0.5 bg-white shadow-md overflow-hidden border-2 border-sky-100 relative">
                                                <img 
                                                    src={avatars[teacher.name]} 
                                                    alt={teacher.name}
                                                    className="w-full h-full object-cover bg-slate-50"
                                                />
                                                <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover/avatar:opacity-100 transition-opacity">
                                                    <Camera size={20} className="text-white" />
                                                </div>
                                            </div>
                                            {isKing && (
                                                <div className="absolute -top-4 -right-2 transform rotate-12 animate-bounce z-10 pointer-events-none">
                                                    <Crown size={28} className="text-yellow-500 fill-yellow-400 drop-shadow-md" />
                                                </div>
                                            )}
                                        </div>
                                        <div>
                                            <div className="flex items-center gap-2">
                                                <span className="font-bold text-lg text-slate-800">{teacher.name}</span>
                                                {isKing && <span className="text-[10px] font-black text-yellow-600 bg-yellow-100 px-1.5 py-0.5 rounded shadow-sm border border-yellow-200">KING</span>}
                                            </div>
                                            <div className="text-xs text-slate-400 flex gap-2 mt-0.5">
                                                <span className="bg-slate-100 px-2 py-0.5 rounded-md text-slate-500">ä»£èª²: {teacher.substituteCount}</span>
                                                <span className="bg-slate-100 px-2 py-0.5 rounded-md text-slate-500">ä»£å°: {teacher.homeroomScore}åˆ†</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-3xl font-black text-sky-600 tabular-nums tracking-tighter drop-shadow-sm font-handwriting">
                                            {teacher.totalPoints}
                                        </div>
                                        <div className="text-[10px] text-sky-300 font-bold uppercase tracking-wide">Points</div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            // --- å…§éƒ¨çµ„ä»¶ï¼šæ–°å¢ç´€éŒ„é¢æ¿ ---
            const AddRecordPanel = () => (
                <div className="bg-white p-6 rounded-3xl shadow-sm border border-sky-50">
                    <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <Plus className="text-sky-500" size={20}/> å¿«é€Ÿè¨˜ä¸€ç­†
                    </h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {TEACHERS.map(teacher => (
                            <div key={teacher} className="bg-sky-50/50 p-4 rounded-2xl border border-sky-100 hover:shadow-md transition-all">
                                <div className="flex items-center gap-3 mb-3">
                                    <div 
                                        className="w-8 h-8 rounded-full overflow-hidden border border-white shadow-sm relative group cursor-pointer"
                                        onClick={() => triggerUpload(teacher)}
                                    >
                                        <img src={avatars[teacher]} alt={teacher} className="w-full h-full object-cover"/>
                                    </div>
                                    <span className="font-bold text-slate-700">{teacher}</span>
                                </div>
                                
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => handleAddRecord(teacher, 'period')}
                                        className="flex-1 py-2 bg-white text-sky-600 rounded-lg text-xs font-bold border border-sky-100 hover:bg-sky-500 hover:text-white transition-colors"
                                        title="ä»£ä¸€ç¯€èª² +1"
                                    >
                                        +1
                                    </button>
                                    <button 
                                        onClick={() => handleAddRecord(teacher, 'homeroom_half')}
                                        className="flex-1 py-2 bg-white text-purple-600 rounded-lg text-xs font-bold border border-purple-100 hover:bg-purple-500 hover:text-white transition-colors"
                                        title="ä»£å°åŠæ—¥ +2.5"
                                    >
                                        +2.5
                                    </button>
                                    <button 
                                        onClick={() => handleAddRecord(teacher, 'homeroom_full')}
                                        className="flex-1 py-2 bg-white text-pink-600 rounded-lg text-xs font-bold border border-pink-100 hover:bg-pink-500 hover:text-white transition-colors"
                                        title="ä»£å°å…¨æ—¥ +5"
                                    >
                                        +5
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            // --- å…§éƒ¨çµ„ä»¶ï¼šæ­·å²ç´€éŒ„åˆ—è¡¨ ---
            const HistoryList = () => {
                const monthRecords = records.filter(r => r.dateStr.startsWith(selectedMonth));
                
                return (
                    <div className="bg-white rounded-3xl shadow-sm border border-sky-100 overflow-hidden flex flex-col h-full min-h-[300px]">
                        <div className="p-4 border-b border-sky-50 flex justify-between items-center bg-slate-50/50">
                            <h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">
                                <History className="text-sky-500" size={20} /> æ­·å²ç´€éŒ„
                            </h3>
                            <span className="text-xs text-slate-400">{monthRecords.length} ç­†</span>
                        </div>

                        {monthRecords.length === 0 ? (
                            <div className="p-12 text-center text-slate-400 flex flex-col items-center justify-center flex-1">
                                <div className="bg-sky-50 p-4 rounded-full mb-3">
                                    <AlertCircle size={32} className="opacity-50 text-sky-400" />
                                </div>
                                <p className="font-medium text-slate-500">é€™å€‹æœˆé‚„æ²’æœ‰ä»»ä½•ç´€éŒ„</p>
                            </div>
                        ) : (
                            <div className="overflow-y-auto custom-scrollbar flex-1 max-h-[400px]">
                                {monthRecords
                                    .sort((a, b) => b.id - a.id)
                                    .map(record => (
                                    <div key={record.id} className="p-4 border-b border-slate-50 flex items-center justify-between hover:bg-sky-50/30 transition-colors group">
                                        <div className="flex items-center gap-4">
                                            <div className="w-10 h-10 rounded-full overflow-hidden border border-slate-100 shadow-sm shrink-0">
                                                <img src={avatars[record.teacher]} alt={record.teacher} className="w-full h-full object-cover"/>
                                            </div>
                                            <div>
                                                <div className="font-bold text-slate-700 text-sm md:text-base">
                                                    {record.teacher} <span className="text-slate-400 font-normal text-xs mx-1">æ–°å¢äº†</span> {SCORING_RULES[record.ruleKey].label}
                                                </div>
                                                <div className="text-xs text-slate-400 flex items-center gap-1 mt-0.5">
                                                    <Calendar size={10} />
                                                    {new Date(record.id).toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute:'2-digit' })}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <span className="font-black text-sky-600 text-lg">+{record.points}</span>
                                            <button 
                                            onClick={() => handleDeleteRecord(record.id)}
                                            className="text-slate-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-all"
                                            title="åˆªé™¤"
                                            >
                                                <Trash2 size={18} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-sky-50 font-sans text-slate-700">
                    
                    {/* éš±è—çš„ä¸Šå‚³ Input */}
                    <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />

                    {/* Header */}
                    <header className="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-sky-100 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="bg-gradient-to-br from-sky-400 to-blue-600 text-white p-1.5 rounded-lg shadow-sm">
                                    <Crown size={20} className="fill-yellow-300 text-yellow-300"/>
                                </div>
                                <h1 className="font-black text-xl text-slate-800 tracking-tight hidden sm:block">ä»£èª²ç‹ <span className="text-sky-500">Web</span></h1>
                            </div>
                            
                            <div className="flex items-center gap-2 bg-sky-100 border border-sky-200 px-3 py-1.5 rounded-full text-sm hover:bg-sky-50 transition-colors">
                                <Calendar size={16} className="text-sky-600"/>
                                <input 
                                    type="month" 
                                    value={selectedMonth}
                                    onChange={(e) => setSelectedMonth(e.target.value)}
                                    className="bg-transparent border-none outline-none text-sky-900 font-bold cursor-pointer text-sm"
                                />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8 space-y-8">
                        
                        {/* Banner Section (æ¨™é¡Œ) */}
                        <div className="text-center space-y-4">
                            <h1 className="text-3xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-sky-600 via-blue-500 to-indigo-500 tracking-tight drop-shadow-sm flex items-center justify-center gap-3">
                                <span className="text-4xl md:text-6xl filter drop-shadow-md">ğŸ‘‘</span> èª°æ˜¯ä»£èª²ç‹
                            </h1>
                            <p className="text-sky-700 font-bold text-sm md:text-base bg-white/60 backdrop-blur px-6 py-2 rounded-full inline-block border border-sky-100 shadow-sm tracking-wide">
                                èª°æ˜¯ç˜‹ç‹‚ä»£å°çš„æ³•å¤–å¤§ç‹‚å¾’
                            </p>
                        </div>

                        {/* --- éŸ¿æ‡‰å¼ä½ˆå±€æ ¸å¿ƒ --- */}
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                            
                            {/* å·¦å´ï¼šæ’è¡Œæ¦œ */}
                            <div className="lg:col-span-4 lg:sticky lg:top-24">
                                <LeaderboardCard />
                            </div>

                            {/* å³å´ï¼šæ“ä½œå€ */}
                            <div className="lg:col-span-8 flex flex-col gap-6">
                                
                                {/* é›»è…¦ç‰ˆï¼šç›´æ¥é¡¯ç¤º Add Panel å’Œ History */}
                                <div className="hidden lg:flex flex-col gap-6">
                                    <AddRecordPanel />
                                    <HistoryList />
                                </div>

                                {/* æ‰‹æ©Ÿç‰ˆï¼šä½¿ç”¨ Tabs åˆ‡æ› */}
                                <div className="lg:hidden">
                                    <div className="flex gap-2 bg-white p-1.5 rounded-2xl shadow-sm border border-sky-100 mb-4">
                                        <button 
                                            onClick={() => setActiveTab('add')}
                                            className={`flex-1 py-3 text-sm font-bold rounded-xl flex items-center justify-center gap-2 transition-all ${activeTab === 'add' ? 'bg-sky-500 text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}
                                        >
                                            <LayoutDashboard size={18} /> è¨˜ä¸€ç­†
                                        </button>
                                        <button 
                                            onClick={() => setActiveTab('history')}
                                            className={`flex-1 py-3 text-sm font-bold rounded-xl flex items-center justify-center gap-2 transition-all ${activeTab === 'history' ? 'bg-sky-500 text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}
                                        >
                                            <List size={18} /> æŸ¥ç´€éŒ„
                                        </button>
                                    </div>
                                    
                                    {/* æ‰‹æ©Ÿç‰ˆ Tab å…§å®¹ */}
                                    <div className="animate-in fade-in slide-in-from-bottom-4 duration-300">
                                        {activeTab === 'add' ? <AddRecordPanel /> : <HistoryList />}
                                    </div>
                                </div>

                            </div>
                        </div>
                    </main>
                    
                    <div className="text-center text-slate-400 text-xs py-8">
                        <p>é»æ“Šé ­åƒå³å¯æ›´æ›ç…§ç‰‡ Â· è³‡æ–™å„²å­˜æ–¼æœ¬æ©Ÿ</p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SubstituteKingApp />);
    </script>
</body>
</html>